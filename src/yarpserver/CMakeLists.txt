# Copyright: (C) 2009 RobotCub Consortium
# Author: Paul Fitzpatrick
# CopyPolicy: Released under the terms of the LGPLv2.1 or later, see LGPL.TXT

if (YARP_USE_PERSISTENT_NAMESERVER)

  option(YARP_USE_SYSTEM_SQLITE "Use system-installed Sqlite, rather than a private copy" FALSE)

  include_directories(${CMAKE_CURRENT_SOURCE_DIR})

  if (YARP_USE_SYSTEM_SQLITE)
    set(SQLITE_SOURCE)
  else ()
    set(SQLITE_SOURCE sqlite/sqlite3.c sqlite/sqlite3.h)
    include_directories(${CMAKE_CURRENT_SOURCE_DIR}/sqlite)
  endif()
  include_directories(${ACE_INCLUDE_DIRS})

  set_property(GLOBAL APPEND PROPERTY YARP_TREE_INCLUDE_DIRS 
    ${CMAKE_CURRENT_SOURCE_DIR}/include)
  get_property(YARP_TREE_INCLUDE_DIRS TARGET YARP_name PROPERTY INCLUDE_DIRS)
  include_directories(${YARP_TREE_INCLUDE_DIRS})
  include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include)

  add_library(yarpserversql ${SQLITE_SOURCE} src/TripleSourceCreator.cpp src/TripleSourceCreator.h src/Triple.h src/TripleSource.h src/SqliteTripleSource.h ${CMAKE_CURRENT_SOURCE_DIR}/src/NameServiceOnTriples.cpp ${CMAKE_CURRENT_SOURCE_DIR}/src/NameServiceOnTriples.h ${CMAKE_CURRENT_SOURCE_DIR}/src/Allocator.h ${CMAKE_CURRENT_SOURCE_DIR}/src/AllocatorOnTriples.cpp ${CMAKE_CURRENT_SOURCE_DIR}/src/AllocatorOnTriples.h ${CMAKE_CURRENT_SOURCE_DIR}/src/Subscriber.h ${CMAKE_CURRENT_SOURCE_DIR}/src/SubscriberOnSql.h ${CMAKE_CURRENT_SOURCE_DIR}/src/SubscriberOnSql.cpp ${CMAKE_CURRENT_SOURCE_DIR}/src/ComposedNameService.h ${CMAKE_CURRENT_SOURCE_DIR}/src/ConnectThread.h ${CMAKE_CURRENT_SOURCE_DIR}/src/ParseName.h ${CMAKE_CURRENT_SOURCE_DIR}/src/ParseName.cpp ${CMAKE_CURRENT_SOURCE_DIR}/src/yarpserver3.cpp)
  target_link_libraries(yarpserversql YARP_init YARP_name)
  if (YARP_USE_SYSTEM_SQLITE)
    target_link_libraries(yarpserversql sqlite3)
  endif ()
  if (UNIX)
    target_link_libraries(yarpserversql dl)
  endif ()

  # preserve yarpserver3 executable for a while
  add_executable(yarpserver3 ${CMAKE_CURRENT_SOURCE_DIR}/src/main.cpp)
  target_link_libraries(yarpserver3 yarpserversql)

  add_executable(yarpserver ${CMAKE_CURRENT_SOURCE_DIR}/src/main.cpp)
  target_link_libraries(yarpserver yarpserversql)

  INSTALL(TARGETS yarpserversql COMPONENT utilities DESTINATION lib)
  INSTALL(TARGETS yarpserver yarpserver3 COMPONENT utilities DESTINATION bin)

  ###############################################################
  ## Some extra test programs

  IF (TEST_BUILD)
    ADD_EXECUTABLE(server_peek src/server_peek.cpp)
    TARGET_LINK_LIBRARIES(server_peek yarpserversql)
    ADD_EXECUTABLE(server_test src/server_test.cpp)
  ENDIF (TEST_BUILD)

endif ()
